#!/usr/bin/env bash
# scaffold.sh — Create a Vite project for an interactive study guide
#
# Usage: bash scaffold.sh <output-directory> "<project-name>"
# Example: bash scaffold.sh ./my-guide "Redis Internals"

set -euo pipefail

OUTPUT_DIR="${1:?Usage: scaffold.sh <output-directory> \"<project-name>\"}"
PROJECT_NAME="${2:-Interactive Study Guide}"

if [ -d "$OUTPUT_DIR" ]; then
  echo "Error: Directory '$OUTPUT_DIR' already exists."
  exit 1
fi

echo "Creating interactive study guide project: $PROJECT_NAME"
echo "Output directory: $OUTPUT_DIR"

mkdir -p "$OUTPUT_DIR/src"

# --- package.json ---
cat > "$OUTPUT_DIR/package.json" << 'PKGJSON'
{
  "name": "interactive-study-guide",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite --open",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "d3": "^7.9.0",
    "prismjs": "^1.29.0"
  },
  "devDependencies": {
    "vite": "^6.0.0"
  }
}
PKGJSON

# --- vite.config.js ---
cat > "$OUTPUT_DIR/vite.config.js" << 'VITECONF'
import { defineConfig } from 'vite';

export default defineConfig({
  root: '.',
  server: {
    open: true,
  },
});
VITECONF

# --- index.html ---
cat > "$OUTPUT_DIR/index.html" << INDEXHTML
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${PROJECT_NAME} — Study Guide</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,700;1,6..72,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/styles.css">
</head>
<body>
  <div class="reading-progress"></div>

  <div class="page">
    <nav class="nav" aria-label="Study guide sections">
      <!-- Navigation links will be generated by main.js -->
    </nav>

    <main class="page__content">
      <!-- Section content will be generated by main.js -->
    </main>
  </div>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
INDEXHTML

# --- src/styles.css (design system) ---
cat > "$OUTPUT_DIR/src/styles.css" << 'STYLES'
/* ==========================================================================
   Interactive Study Guide — Editorial Design System
   ========================================================================== */

:root {
  /* Typography */
  --font-serif: 'Newsreader', 'Georgia', 'Times New Roman', serif;
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Consolas', monospace;

  --text-hero: clamp(2.5rem, 5vw, 4rem);
  --text-h1: clamp(2rem, 4vw, 3rem);
  --text-h2: clamp(1.5rem, 3vw, 2rem);
  --text-h3: 1.25rem;
  --text-body: 1.0625rem;
  --text-small: 0.875rem;
  --text-caption: 0.8125rem;
  --text-mono: 0.875rem;

  --leading-tight: 1.2;
  --leading-body: 1.65;
  --leading-relaxed: 1.8;
  --measure: 38rem;

  /* Color — Light */
  --ink: #1a1a2e;
  --ink-secondary: #4a4a68;
  --ink-muted: #8888a0;
  --surface: #ffffff;
  --surface-raised: #fafafa;
  --surface-sunken: #f3f3f8;
  --border: #e2e2ea;
  --border-light: #f0f0f5;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --accent-dark: #1d4ed8;

  /* Semantic */
  --think: #f59e0b;
  --think-bg: #fffbeb;
  --explore: #10b981;
  --explore-bg: #ecfdf5;
  --code-bg: #1e1e2e;
  --code-text: #cdd6f4;

  /* Spacing */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --space-12: 3rem;
  --space-16: 4rem;
  --space-24: 6rem;
  --space-32: 8rem;

  /* Motion */
  --ease-standard: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-enter: cubic-bezier(0, 0, 0.2, 1);
  --ease-exit: cubic-bezier(0.4, 0, 1, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
  --duration-instant: 100ms;
  --duration-fast: 200ms;
  --duration-medium: 350ms;
  --duration-slow: 500ms;
  --duration-dramatic: 800ms;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(26, 26, 46, 0.05);
  --shadow-md: 0 4px 12px rgba(26, 26, 46, 0.08);
  --shadow-lg: 0 8px 24px rgba(26, 26, 46, 0.12);

  /* Borders */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;

  /* Layout */
  --sidebar-width: 240px;
  --content-max: 64rem;
  --gutter: var(--space-6);
}

@media (prefers-color-scheme: dark) {
  :root {
    --ink: #e4e4ef;
    --ink-secondary: #a0a0b8;
    --ink-muted: #6b6b82;
    --surface: #121220;
    --surface-raised: #1a1a2e;
    --surface-sunken: #0e0e1a;
    --border: #2a2a3e;
    --border-light: #1e1e30;
    --accent: #60a5fa;
    --accent-light: #1e3a5f;
    --accent-dark: #93bbfd;
    --think-bg: #2a2010;
    --explore-bg: #0a2a1a;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
  }
}

/* Base */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  font-size: 16px;
  scroll-behavior: smooth;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: var(--font-sans);
  font-size: var(--text-body);
  line-height: var(--leading-body);
  color: var(--ink);
  background: var(--surface);
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* Typography */
h1, h2, h3 {
  font-family: var(--font-serif);
  line-height: var(--leading-tight);
  color: var(--ink);
  letter-spacing: -0.02em;
}

h1 { font-size: var(--text-h1); }
h2 { font-size: var(--text-h2); margin-bottom: var(--space-4); }
h3 { font-size: var(--text-h3); margin-bottom: var(--space-3); }

p { max-width: var(--measure); margin-bottom: var(--space-4); }

code, pre { font-family: var(--font-mono); font-size: var(--text-mono); }

code:not(pre code) {
  background: var(--surface-sunken);
  padding: 0.15em 0.4em;
  border-radius: var(--radius-sm);
  font-size: 0.9em;
}

pre {
  background: var(--code-bg);
  color: var(--code-text);
  padding: var(--space-6);
  border-radius: var(--radius-md);
  overflow-x: auto;
  line-height: 1.6;
  margin: var(--space-4) 0;
}

pre code { background: none; padding: 0; }

/* Layout */
.page {
  display: grid;
  grid-template-columns: var(--sidebar-width) 1fr;
  min-height: 100vh;
}

@media (max-width: 768px) { .page { grid-template-columns: 1fr; } }

.page__content {
  max-width: var(--content-max);
  margin: 0 auto;
  padding: var(--space-8) var(--gutter);
}

/* Navigation */
.nav {
  position: sticky;
  top: 0;
  height: 100vh;
  padding: var(--space-8) var(--space-6);
  border-right: 1px solid var(--border-light);
  overflow-y: auto;
}

.nav__link {
  display: block;
  padding: var(--space-2) var(--space-3);
  color: var(--ink-muted);
  text-decoration: none;
  font-size: var(--text-small);
  border-radius: var(--radius-sm);
  transition: color var(--duration-fast) var(--ease-standard),
              background var(--duration-fast) var(--ease-standard);
}

.nav__link:hover { color: var(--ink); background: var(--surface-sunken); }
.nav__link.active { color: var(--accent); font-weight: 500; }

@media (max-width: 768px) {
  .nav {
    position: fixed; bottom: 0; left: 0; right: 0; top: auto;
    height: auto; display: flex; overflow-x: auto;
    padding: var(--space-3) var(--space-4);
    background: var(--surface);
    border-right: none; border-top: 1px solid var(--border-light);
    z-index: 100;
  }
  .nav__link { white-space: nowrap; }
}

/* Reading Progress */
.reading-progress {
  position: fixed; top: 0; left: 0;
  height: 3px; background: var(--accent);
  z-index: 1000; transition: width 100ms linear;
}

/* Sections */
.section {
  padding: var(--space-24) 0;
  border-bottom: 1px solid var(--border-light);
  opacity: 0; transform: translateY(24px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}

.section.visible { opacity: 1; transform: translateY(0); }
.section:last-child { border-bottom: none; }
.section__header { margin-bottom: var(--space-12); }

.section--hero {
  min-height: 100vh;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  text-align: center;
  padding: var(--space-16) var(--gutter);
  border-bottom: none;
  opacity: 1; transform: none; /* hero is always visible */
}

.hero__label {
  font-family: var(--font-sans); font-size: var(--text-small);
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--ink-muted); margin-bottom: var(--space-2);
}

.hero__title {
  font-size: var(--text-hero); font-weight: 700; letter-spacing: -0.03em;
}

.hero__divider {
  width: 60px; height: 2px;
  background: var(--accent);
  margin: var(--space-8) auto;
}

.hero__problem {
  max-width: var(--measure);
  font-family: var(--font-serif);
  font-size: var(--text-h3);
  font-style: italic;
  color: var(--ink-secondary);
  margin-bottom: var(--space-6);
}

.hero__approach {
  max-width: var(--measure);
  color: var(--ink-secondary);
}

.hero__scroll-hint {
  position: absolute; bottom: var(--space-8);
  font-size: var(--text-small); color: var(--ink-muted);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

.section__title { font-size: var(--text-h2); margin-bottom: var(--space-2); }

.section__subtitle {
  font-size: var(--text-body); color: var(--ink-secondary);
  max-width: var(--measure);
}

/* --- Components are added here by Claude during build --- */
STYLES

# --- src/main.js (minimal bootstrap) ---
cat > "$OUTPUT_DIR/src/main.js" << 'MAINJS'
/**
 * Interactive Study Guide — Main Entry
 *
 * This file bootstraps the interactive study guide.
 * Replace the placeholder content below with generated sections.
 */

import Prism from 'prismjs';
import * as d3 from 'd3';

// Make d3 available globally for section scripts
window.d3 = d3;

// --- Reading Progress Bar ---
function initProgressBar() {
  const bar = document.querySelector('.reading-progress');
  if (!bar) return;
  window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
    bar.style.width = `${progress}%`;
  }, { passive: true });
}

// --- Scroll-Spy Navigation ---
function initScrollSpy() {
  const sections = document.querySelectorAll('.section[id]');
  const navLinks = document.querySelectorAll('.nav__link');
  if (!sections.length || !navLinks.length) return;

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        navLinks.forEach(link => {
          link.classList.toggle('active',
            link.getAttribute('href') === `#${entry.target.id}`);
        });
      }
    });
  }, { rootMargin: '-20% 0px -60% 0px' });

  sections.forEach(section => observer.observe(section));
}

// --- Section Entrance Animations ---
function initSectionAnimations() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.section:not(.section--hero)').forEach(s => {
    observer.observe(s);
  });
}

// --- Syntax Highlighting ---
function highlightCode() {
  Prism.highlightAll();
}

// --- Initialize ---
document.addEventListener('DOMContentLoaded', () => {
  initProgressBar();
  initScrollSpy();
  initSectionAnimations();
  highlightCode();
});
MAINJS

echo ""
echo "Project created at: $OUTPUT_DIR"
echo ""
echo "Next steps:"
echo "  cd $OUTPUT_DIR"
echo "  npm install"
echo "  npm run dev"
